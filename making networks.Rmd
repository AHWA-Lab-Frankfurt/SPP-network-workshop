---
title: "Making Networks"
author: "Nikolas Gestrich, Juan-Marco Puerta-Schardt"
date: "6/3/2021"
output: html_document
---



#network:
The adjacency matrix or the edgelist can now be used to create an network object. There are different packages that work with networks but a combination of "tidygraph"(clean& easy network data), "igraph" (network statistics) and "ggraph" (network visualisation) is the most convinient way. 
This network objects (often also called graph objects) is used for all further visualisations or analysis. 
```{r creating network objects}
library(tidygraph)


#tidygraph::as_tbl_graph is a pretty powerfull function that can turn adjacency matrices and edgelists(+nodelists) into network objects
mbk3Pnet <- tidygraph::as_tbl_graph(mbk3mat, directed = FALSE)

#view doesnt work with network objects, but it isnt necessary to look at objects anyway. An object can also just be looked at by calling its name as if it was a function
mbk3Pnet
#It consists of node data(the sites) and edge data (the connections based on copresence of pottery)


#as_tbl_graph also works with node and edge lists. The function needs to be told which list to use for nodes and which list for edges. 
mbk3EPnet <- decor.graph <- tbl_graph(nodes = mbk3nodes, edges = mbk3edges, directed = FALSE)

  
#lets look if it worked
  mbk3Pnet
```

#networkvisualization:
the network object itself doesnt give much information in the first place. But it is the basis to visualize the network. The visualisation can be used to get an overview on the structure of our network. 
```{r}
library(ggraph)
 
#the first command is the base of the plot containing data and the layout, here the data is our network graph based on the adjacency matrix and the layout is a standard layout that tries to minimize the overlapping of edges by positioning the nodes according to there position in the network.
ggraph(mbk3Pnet, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges 
    geom_edge_link() +
  #then the nodes plotted as points
  geom_node_point()+
 #to distinguish the pottery we add a layer that contains there names. The aes(label = name) uses the names in the node list; the color="red" changes the color to make it easier to read. we will later show more ways to manipulate the layers to make more information vible
   geom_node_text(aes(label = name), color = "red")
  
 ##this is how an edgelist is transformed to a network with as_tbl_graph()
#netpotteryEP <- tidygraph::as_tbl_graph(edge.cop) 

 #this time we use the network based on the edgelist.
  ggraph(mbk3EPnet, layout = "graphopt") +
  geom_edge_link() +
  geom_node_point()+
  geom_node_text(aes(label = id), color = "red")
  
  #what is the small difference?
```

#networkvisualization2:
now that we know that the networks are (nearly) the same we will continue working only with netpotteryP. we can extend the plot layers with aes() to make more sophisted plots that allow us to see more 
```{r}
 ggraph(mbk3Pnet, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the width of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(edge_width = weight), alpha = 0.5) +
  geom_node_point()+
  geom_node_text(aes(label = name))

ggraph(mbk3Pnet, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()+
  geom_node_text(aes(label = name))

ggraph(mbk3EPnet, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()+
  geom_node_text(aes(label = id))
```

#working with the node list/visualisation3: 
Maybe you want to compare the network to the landscape to check if geographic position plays a role for the connections. As we have coordinates in our data, but not yet in our network data. we need to add it first. The data can be added to the node list (if it is sitedata) or to the edgelist(if it would be data regarding the connection).
```{r nodelist and coords}
#we extract the coordinates for the sites of our period from the data
 coords <- Michelsberg %>% 
  #for the start we only want one phase
  filter(mbk_phase == "III") %>%
 #we select the 
   select(x_utm32n, y_utm32n)
  
  
mbk3Pnet <- mbk3Pnet %>% 
  activate(nodes) %>% 
  mutate("lon" = coords$x_utm32n, "lat" = coords$y_utm32n)
  
mbk3Pnet

#To use coordinates, x = lon & y = lat are used instead of a layout based on the position inside a network
ggraph(mbk3Pnet, x = lon, y = lat) +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()
#labels are removed to make it less fuzzy
```
#centrality:
There are various statistical measurements for networks. Centrality scores are one of the most basic ones and give a good overview on the role of the node. There are many different ways to calculate centralities. They are all based on the connectedness of the node, the weight of the connections can be considered but does not need to be taken into account. 
The simplest centrality score is "degree centrality". It just counts the edges a node has. It is a relatively plain measure for the role of a node as it shows if it has many connections or only few. A node with a low "degree centrality" is probably a more isolated node on the margins of the network, while node with a high "degree centrality" is well connected and in a more central position. As the connections in archeological data are often based on similar artifacts, "degree centrality" indicates how similar the assemblage of a site is to others in the network.
If the "degree centrality" is weighted, it is the sum of the weight of the edges a node has. Therefore it not only shows how many connections a node has but also how strong they are. This often helps to get a more distinctive view on its role in the network.
```{r degree centrality}
library(igraph)
mbk3Pnet %>% 
 #activating the node list to add the degree centrality score there
   activate(nodes) %>% 
  #adding the column deg to the node list
  mutate(deg = centrality_degree()) %>% 
  #getting only the node list as a dataframe
  get.data.frame(what = c("vertices")) %>% 
  #selecting deg as a shown column
  select(deg) %>% 
  #arranging it descending
  arrange(-deg)

  
ggraph(netpotteryP, x = lon, y = lat) +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
 #the function centtrality_degree() can be called directly as an attribute that will be visualized
   geom_node_point(aes(size = centrality_degree(weights = weight)))
#labels are removed to make it less fuzzy

```


```{r higher thresh}
co.p(Michelsberg.pot, 0.25) %>% 
  as_tbl_graph() %>% 
  activate(nodes) %>% 
  mutate("lon" = coords$x_utm32n, "lat" = coords$y_utm32n) %>% 
 # filter(!node_is_isolated()) %>% 
  ggraph(x = lon, y = lat) +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()


co.p(Michelsberg.pot, 0.25) %>% 
  as_tbl_graph() %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated()) %>% 
  ggraph(layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()+
  geom_node_text(aes(label = name))
```
