---
title: "Making Networks"
author: "Nikolas Gestrich, Juan-Marco Puerta-Schardt"
date: "6/3/2021"
output: html_document
---



#network:
The adjacency matrix or the edgelist can now be used to create an network object. There are different packages that work with networks but a combination of "tidygraph"(clean& easy network data), "igraph" (network statistics) and "ggraph" (network visualisation) is the most convinient way. 
```{r creating network objects}
library(tidygraph)


#tidygraph::as_tbl_graph is a pretty powerfull function that can turn adjacency matrices and edgelists into network objects
netpotteryP <- tidygraph::as_tbl_graph(potteryP)

#view doesnt work with network objects, but it isnt necessary to look at things anyway. an object can also just be looked at by calling its name as if it was a function
netpotteryP
#we see that it consists of node data(the pottery) and edge data (the connections based on copresence of pottery)


###now it is time for you to try something out yourself. transform the edgelist into a network object by using the same function as above on edge.cop
#write the command behind the arrow to save the network under the name netpotteryEP
#if you dont know what to do you can look in the next chunk for the proper way
netpotteryEP <- 
  
#lets look if it worked
  netpotteryEP
```

#networkvisualization:
the network object itself doesnt give much information in the first place. But it is the basis to visualize the network. The visualisation can be used to get an overview on the structure of our network. 
```{r}
library(ggraph)
 
#the first command is the base of the plot containing data and the layout, here the data is our network graph based on the adjacency matrix
ggraph(potteryP, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges 
    geom_edge_link() +
  #then the nodes plotted as points
  geom_node_point()+
 #to distinguish the pottery we add a layer that contains there names. The aes(label = name) uses the names in the node list; the color="red" changes the color to make it easier to read. we will later show more ways to manipulate the layers to make more information vible
   geom_node_text(aes(label = name), color = "red")
  
 ##this is how an edgelist is transformed to a network with as_tbl_graph()
 netpotteryEP <- tidygraph::as_tbl_graph(edge.cop) 

 #this time we use the network based on the edgelist.
  ggraph(netpotteryEP, layout = "graphopt") +
  geom_edge_link() +
  geom_node_point()+
  geom_node_text(aes(label = name), color = "red")
  
  #what is the small difference?
```

#networkvisualization2:
now that we know that the networks are (nearly) the same we will continue working only with netpotteryP. we can extend the plot layers with aes() to make more sophisted plots that allow us to see more 
```{r}
 ggraph(potteryP, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the width of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(edge_width = weight), alpha = 0.5) +
  geom_node_point()+
  geom_node_text(aes(label = name))

ggraph(potteryP, layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()+
  geom_node_text(aes(label = name))
```

#working with the node list/visualisation3: maybe you want to compare the network to the landscape to check if geographic position plays a role for the connections. as we have coordinates in our data, but not yet in our network data. we need to add it first. The data can be added to the node list (if it is sitedata) or to the edgelist(if it would be data regarding the connection)
```{r nodelist and coords}
#we extract the coordinates for the sites of our period from the data
 coords <- Michelsberg %>% 
  #for the start we only want one phase
  filter(mbk_phase == "III") %>%
  select(x_utm32n, y_utm32n)
  
  
netpotteryP <- netpotteryP %>% 
  activate(nodes) %>% 
  mutate("lon" = coords$x_utm32n, "lat" = coords$y_utm32n)
  
netpotteryP
ggraph(netpotteryP, x = lon, y = lat) +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()
#labels are removed to make it less fuzzy
```

```{r degree centrality}
library(igraph)
netpotteryP %>% 
  activate(nodes) %>% 
  mutate(deg = centrality_degree()) %>% 
  get.data.frame(what = c("vertices")) %>% 
  select(deg) %>% 
  arrange(-deg)

centrality_de
  
ggraph(netpotteryP, x = lon, y = lat) +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point(aes(size = centrality_degree(weights = weight)))
#labels are removed to make it less fuzzy

```
```{r higher thresh}
co.p(Michelsberg.pot, 0.25) %>% 
  as_tbl_graph() %>% 
  activate(nodes) %>% 
  mutate("lon" = coords$x_utm32n, "lat" = coords$y_utm32n) %>% 
 # filter(!node_is_isolated()) %>% 
  ggraph(x = lon, y = lat) +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()


co.p(Michelsberg.pot, 0.25) %>% 
  as_tbl_graph() %>% 
  activate(nodes) %>% 
  filter(!node_is_isolated()) %>% 
  ggraph(layout = "stress") +
#with every layer we add some new part of our network to the plot; first the edges;now the color of the edges is based on there weight. this way we can see which pottery share more than just a single object
    geom_edge_link(aes(color = weight), alpha = 0.5) +
scale_edge_color_continuous(low = "lightblue", high = "red") +
  geom_node_point()+
  geom_node_text(aes(label = name))
```
